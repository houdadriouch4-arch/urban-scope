<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Urban Scope ‚Äî D√©cision urbaine & sanitaire (Front-end)</title>

  <!-- Police -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    :root{
      --bg:#f6fbff; --card:#fff; --muted:#475569; --text:#0f172a;
      --accent:#0ea5e9; --accent2:#22c55e;
    }
    *{box-sizing:border-box;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1400px 700px at 70% -20%, #e6f3ff 0%, var(--bg) 60%);color:var(--text)}

    header{position:sticky;top:0;z-index:10;display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:10px 14px;background:rgba(255,255,255,.85);backdrop-filter:blur(6px);border-bottom:1px solid rgba(15,23,42,.1)}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(45deg,var(--accent),var(--accent2));box-shadow:0 0 12px rgba(59,130,246,.4)}
    nav{display:flex;gap:8px}
    nav button{cursor:pointer;border-radius:12px;padding:8px 12px;border:1px solid rgba(15,23,42,.12);background:#fff}
    nav button.active,nav button:hover{background:#e6f3ff;border-color:rgba(14,165,233,.45)}

    .container{max-width:1100px;margin:22px auto;padding:0 16px}
    .card{background:#fff;border:1px solid rgba(15,23,42,.08);border-radius:16px;box-shadow:0 8px 30px rgba(15,23,42,.06)}
    .card .hd{padding:14px 16px;border-bottom:1px dashed rgba(148,163,184,.18);font-weight:700}
    .card .bd{padding:16px}
    .muted{color:var(--muted)}
    .pill{display:inline-block;background:linear-gradient(180deg, rgba(14,165,233,.12), rgba(14,165,233,.05));
      border:1px solid rgba(14,165,233,.35);color:#0369a1;padding:8px 12px;border-radius:999px;font-weight:600;font-size:14px}

    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns:1fr}
    @media(min-width:960px){.grid-2{grid-template-columns:1.2fr .8fr}}

    .btn{appearance:none;border:none;cursor:pointer;border-radius:14px;padding:12px 14px;font-weight:700;
      background:linear-gradient(180deg, rgba(14,165,233,.2), rgba(14,165,233,.1));border:1px solid rgba(14,165,233,.45)}
    .btn.secondary{background:linear-gradient(180deg,#ffffff,#f8fafc);border-color:rgba(15,23,42,.12)}
    .hidden{display:none}
    .small{font-size:12px;color:var(--muted)}

    /* Map & l√©gende */
    #map{width:100%;height:72vh;border-radius:16px;overflow:hidden;border:1px solid rgba(15,23,42,.08)}
    .legend{background:#fff;color:var(--text);padding:8px 10px;border-radius:10px;border:1px solid rgba(15,23,42,.12);line-height:1.1}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .b-warn{background:rgba(245,158,11,.15);color:#b45309;border:1px solid rgba(245,158,11,.35)}
    .b-good{background:rgba(34,197,94,.15);color:#065f46;border:1px solid rgba(34,197,94,.35)}
    .b-poor{background:rgba(239,68,68,.15);color:#7f1d1d;border:1px solid rgba(239,68,68,.35)}

    /* mini h√©ro */
    .home-hero{display:grid;gap:12px;place-items:center;text-align:center;padding:34px 10px}
  </style>
</head>
<body>
  <header>
    <div class="brand"><span class="dot" aria-hidden="true"></span>Urban Scope</div>
    <nav>
      <button id="nav-home" class="active">Accueil</button>
      <button id="nav-urban">Profil Urbanisme</button>
      <button id="nav-health">Profil Sanitaire</button>
      <button id="nav-map">Carte</button>
    </nav>
  </header>

  <main class="container">
    <!-- ACCUEIL -->
    <section id="view-home" class="grid">
      <div class="card">
        <div class="bd home-hero">
          <span class="pill">Prototype front-end ‚Äî donn√©es fictives</span>
          <h1>D√©cision urbaine & sanitaire √† partir de donn√©es spatiales</h1>
          <p class="muted">Explorez le profil Urbanisme (choix de projet), le profil Sanitaire (indicateurs) et la carte interactive.</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
            <button class="btn" data-goto="urban">Commencer ‚Äî Urbanisme</button>
            <button class="btn secondary" data-goto="health">Explorer ‚Äî Sanitaire</button>
            <button class="btn secondary" data-goto="map">Voir la carte</button>
          </div>
        </div>
      </div>
    </section>

    <!-- URBANISME -->
    <section id="view-urban" class="grid-2 grid hidden">
      <div class="card">
        <div class="hd">ü§ñ Recommandations (par choix)</div>
        <div class="bd">
          <form id="form-urban" class="choices" style="display:grid;gap:10px">
            <div>
              <div class="small muted">1) Quel projet voulez-vous cr√©er ?</div>
              <label><input type="radio" name="project" value="hospital" required /> H√¥pital / Clinique</label><br/>
              <label><input type="radio" name="project" value="school" /> √âcole / Universit√© / Cr√®che</label><br/>
              <label><input type="radio" name="project" value="park" /> Parc / Jardin / Sport</label>
            </div>
            <div>
              <div class="small muted">2) Mode</div>
              <label><input type="radio" name="mode" value="map" required /> Choisir sur la carte</label>
              <label style="margin-left:10px"><input type="radio" name="mode" value="auto" /> Recommandation automatique</label>
            </div>
            <button type="submit" class="btn">Continuer</button>
          </form>
          <div id="urban-result" class="hidden" style="margin-top:12px"></div>
        </div>
      </div>
      <div class="card">
        <div class="hd">‚ÑπÔ∏è Bar√®me (simplifi√©)</div>
        <div class="bd small">
          <p><strong>H√¥pital / Clinique</strong> : + densit√©, + incidence maladies, + √©loignement des h√¥pitaux, ‚àí nb h√¥pitaux, + accessibilit√©, ‚àí risques climatiques.</p>
          <p><strong>√âcole / Universit√© / Cr√®che</strong> : + densit√©, ‚àí couverture scolaire existante, + accessibilit√©, ‚àí risques.</p>
          <p><strong>Parc / Jardin / Sport</strong> : + densit√©, ‚àí espaces verts existants, + pollution, + accessibilit√©.</p>
        </div>
      </div>
    </section>

    <!-- SANITAIRE -->
    <section id="view-health" class="grid hidden">
      <div class="card">
        <div class="hd">üè• Profil Sanitaire</div>
        <div class="bd">
          <p class="muted">Cliquez une zone sur la carte pour voir un aper√ßu des pr√©-alertes (semaine prochaine) cardio / pneumo / urgences (simulation).</p>
          <button class="btn" data-goto="map">Ouvrir la carte</button>
        </div>
      </div>
    </section>

    <!-- CARTE -->
    <section id="view-map" class="grid hidden">
      <div class="card">
        <div class="hd">üó∫Ô∏è Carte interactive</div>
        <div class="bd">
          <div id="map"></div>
          <div class="small" style="margin-top:8px;">Fond : OpenStreetMap ‚Ä¢ Les couches sont des jeux fictifs int√©gr√©s (GeoJSON).</div>
        </div>
      </div>
    </section>
  </main>

  <script>
    /* ----- Router tr√®s simple ----- */
    const views = {
      home:  document.getElementById('view-home'),
      urban: document.getElementById('view-urban'),
      health:document.getElementById('view-health'),
      map:   document.getElementById('view-map')
    };
    const navButtons = {
      home:  document.getElementById('nav-home'),
      urban: document.getElementById('nav-urban'),
      health:document.getElementById('nav-health'),
      map:   document.getElementById('nav-map')
    };
    function goto(view){
      Object.values(views).forEach(v=>v.classList.add('hidden'));
      Object.values(navButtons).forEach(b=>b.classList.remove('active'));
      views[view].classList.remove('hidden');
      navButtons[view]?.classList.add('active');
      if(view==='map') setTimeout(()=>map.invalidateSize(),150);
    }
    Object.entries(navButtons).forEach(([k,btn])=>btn.addEventListener('click',()=>goto(k)));
    document.addEventListener('click',(e)=>{const to=e.target.closest('[data-goto]')?.dataset?.goto;if(to) goto(to);});
    goto('home');

    /* ---------- Donn√©es GeoJSON fictives ---------- */
    const DATA_ZONES = {"type":"FeatureCollection","features":[
      {"type":"Feature","properties":{"id":"Z1","name":"Nord","population_density":7800,"hospital_count":1,"hospital_proximity_km":3.2,"disease_incidence":0.28,"school_coverage":0.65,"green_space_per_capita":7,"pollution_index":55,"access_index":0.75,"humidity":60,"temperature_c":29,"risk_heatwave":0.4,"risk_air_pollution":0.35,"climate_alert":false},"geometry":{"type":"Polygon","coordinates":[[[-9.75,31.55],[-9.70,31.55],[-9.70,31.60],[-9.75,31.60],[-9.75,31.55]]]}},
      {"type":"Feature","properties":{"id":"Z2","name":"Sud","population_density":6500,"hospital_count":0,"hospital_proximity_km":5.5,"disease_incidence":0.30,"school_coverage":0.50,"green_space_per_capita":5,"pollution_index":65,"access_index":0.6,"humidity":55,"temperature_c":32,"risk_heatwave":0.8,"risk_air_pollution":0.6,"climate_alert":true},"geometry":{"type":"Polygon","coordinates":[[[-9.75,31.50],[-9.70,31.50],[-9.70,31.55],[-9.75,31.55],[-9.75,31.50]]]}},
      {"type":"Feature","properties":{"id":"Z3","name":"Est","population_density":8200,"hospital_count":2,"hospital_proximity_km":1.8,"disease_incidence":0.26,"school_coverage":0.70,"green_space_per_capita":8,"pollution_index":50,"access_index":0.8,"humidity":58,"temperature_c":28,"risk_heatwave":0.3,"risk_air_pollution":0.3,"climate_alert":false},"geometry":{"type":"Polygon","coordinates":[[[-9.70,31.55],[-9.65,31.55],[-9.65,31.60],[-9.70,31.60],[-9.70,31.55]]]}},
      {"type":"Feature","properties":{"id":"Z4","name":"Ouest","population_density":5000,"hospital_count":0,"hospital_proximity_km":6.0,"disease_incidence":0.35,"school_coverage":0.40,"green_space_per_capita":10,"pollution_index":45,"access_index":0.5,"humidity":62,"temperature_c":27,"risk_heatwave":0.2,"risk_air_pollution":0.25,"climate_alert":false},"geometry":{"type":"Polygon","coordinates":[[[-9.75,31.60],[-9.70,31.60],[-9.70,31.65],[-9.75,31.65],[-9.75,31.60]]]}},
      {"type":"Feature","properties":{"id":"Z5","name":"Centre","population_density":9000,"hospital_count":3,"hospital_proximity_km":1.2,"disease_incidence":0.24,"school_coverage":0.75,"green_space_per_capita":6,"pollution_index":58,"access_index":0.85,"humidity":57,"temperature_c":30,"risk_heatwave":0.5,"risk_air_pollution":0.4,"climate_alert":true},"geometry":{"type":"Polygon","coordinates":[[[-9.70,31.60],[-9.65,31.60],[-9.65,31.65],[-9.70,31.65],[-9.70,31.60]]]}}
    ]};

    const DATA_HEALTH = {"type":"FeatureCollection","features":[
      {"type":"Feature","properties":{"name":"CHU Central","beds":420,"phone":"+212 5 24 00 00 00","email":"contact@chu-central.ma","address":"Av. Principale, Ville"},"geometry":{"type":"Point","coordinates":[-9.70,31.595]}},
      {"type":"Feature","properties":{"name":"Clinique Est","beds":120,"phone":"+212 5 24 11 22 33","email":"info@clinique-est.ma","address":"Bd. Atlas, Quartier Est"},"geometry":{"type":"Point","coordinates":[-9.66,31.605]}},
      {"type":"Feature","properties":{"name":"H√¥pital Sud","beds":260,"phone":"+212 5 24 44 55 66","email":"accueil@hopital-sud.ma","address":"Route du Sud, KM 3"},"geometry":{"type":"Point","coordinates":[-9.71,31.535]}}
    ]};

    const DATA_CLIMATE = {"type":"FeatureCollection","features":[
      {"type":"Feature","properties":{"type":"Temp√©rature","value":29.4,"unit":"¬∞C"},"geometry":{"type":"Point","coordinates":[-9.705,31.585]}},
      {"type":"Feature","properties":{"type":"PM2.5","value":42,"unit":"¬µg/m¬≥"},"geometry":{"type":"Point","coordinates":[-9.695,31.555]}},
      {"type":"Feature","properties":{"type":"Humidit√©","value":57,"unit":"%"},"geometry":{"type":"Point","coordinates":[-9.675,31.615]}}
    ]};

    /* ---------- Helpers & scoring ---------- */
    const safeNum = (v,f=0)=> (typeof v==='number' && isFinite(v)) ? v : f;
    const ranges = (key)=>{ const vals=DATA_ZONES.features.map(f=>safeNum(f.properties[key],null)).filter(v=>v!==null); return vals.length?{min:Math.min(...vals),max:Math.max(...vals)}:{min:0,max:1};};
    const R = {
      pop: ranges('population_density'),
      dis: ranges('disease_incidence'),
      hospNear: ranges('hospital_proximity_km'),
      hospCount: ranges('hospital_count'),
      school: ranges('school_coverage'),
      green: ranges('green_space_per_capita'),
      poll: ranges('pollution_index'),
      access: ranges('access_index')
    };
    function norm(val,{min,max},invert=false){
      val=safeNum(val,min); if(max===min) return .5; const n=(val-min)/(max-min); const c=Math.max(0,Math.min(1,n)); return invert?(1-c):c;
    }
    function scoreZone(p, project){
      const W = {
        hospital:{pop:.25,dis:.25,hospNear:.15,hospCount:.10,access:.10,risk_heatwave:.075,risk_air_pollution:.075},
        school:{pop:.30,school:.25,access:.20,hospNear:.05,hospCount:.05,risk_heatwave:.075,risk_air_pollution:.075},
        park:{pop:.30,green:.30,poll:.20,access:.20}
      }[project];
      const s={
        pop:norm(p.population_density,R.pop),
        dis:norm(p.disease_incidence,R.dis),
        hospNear:norm(p.hospital_proximity_km,R.hospNear),
        hospCount:norm(p.hospital_count,R.hospCount,true),
        school:norm(p.school_coverage,R.school,true),
        green:norm(p.green_space_per_capita,R.green,true),
        poll:norm(p.pollution_index,R.poll),
        access:norm(p.access_index,R.access),
        risk_heatwave:1-(p.risk_heatwave??0),
        risk_air_pollution:1-(p.risk_air_pollution??0)
      };
      let total=0,denom=0; for(const k in W){ total+=(s[k]||0)*W[k]; denom+=W[k]; }
      return { pct: Math.round(100*(total/denom)) };
    }
    function riskBadge(v){ if(v>=.7) return '<span class="badge b-poor">√©lev√©</span>'; if(v>=.45) return '<span class="badge b-warn">mod√©r√©</span>'; return '<span class="badge b-good">faible</span>'; }
    function forecastNextWeekRisk(p){
      const heat=p.risk_heatwave??0, air=p.risk_air_pollution??0, base=p.disease_incidence??0.25;
      return {
        cardio: Math.min(1, 0.5*heat + 0.3*air + 0.4*base),
        pneumo: Math.min(1, 0.3*heat + 0.6*air + 0.4*base),
        urg:    Math.min(1, 0.4*heat + 0.4*air + 0.5*base)
      };
    }

    /* ---------- Carte Leaflet ---------- */
    const map = L.map('map',{zoomControl:true,minZoom:8,maxZoom:18});
    const basemap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'&copy; OpenStreetMap',maxZoom:19
    }).addTo(map);
    map.setView([31.575,-9.70],12);

    let currentProject = 'hospital';
    const colorByPct = (p)=> p>=70?'#16a34a':(p>=45?'#f59e0b':'#ef4444');
    const styleByProject = (f)=>{const {pct}=scoreZone(f.properties,currentProject); return {weight:1,color:'rgba(100,116,139,.6)',fillOpacity:.45,fillColor:colorByPct(pct)};}

    function zonePopup(feature){
      const p = feature.properties;
      const {pct} = scoreZone(p,currentProject);
      const tag = pct>=70?'b-good':(pct>=45?'b-warn':'b-poor');
      const next = forecastNextWeekRisk(p);
      return `
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <strong>${p.name}</strong>
            <span class="badge ${tag}">${pct}% correspondance</span>
          </div>
          <div class="small" style="margin-top:6px;">
            <div>Population : ${safeNum(p.population_density).toLocaleString()} hab/km¬≤</div>
            <div>Incidence maladies : ${(safeNum(p.disease_incidence)*100).toFixed(0)}%</div>
            <div>H√¥pitaux : ${safeNum(p.hospital_count)} (proximit√© ${safeNum(p.hospital_proximity_km)} km)</div>
            <div>Couverture scolaire : ${(safeNum(p.school_coverage)*100).toFixed(0)}%</div>
            <div>Espaces verts/hab : ${safeNum(p.green_space_per_capita)} m¬≤</div>
            <div>Pollution (index) : ${safeNum(p.pollution_index)}</div>
            <div>Accessibilit√© : ${(safeNum(p.access_index)*100).toFixed(0)}%</div>
            <div>Climat : ${safeNum(p.temperature_c)}¬∞C ‚Ä¢ Humidit√© ${safeNum(p.humidity)}%</div>
            <div style="margin-top:6px;"><strong>Pr√©-alertes (semaine pro.)</strong> :
              cardio ${riskBadge(next.cardio)} ‚Ä¢ pneumo ${riskBadge(next.pneumo)} ‚Ä¢ urgences ${riskBadge(next.urg)}
            </div>
          </div>
        </div>`;
    }

    const zonesLayer = L.geoJSON(DATA_ZONES,{style:styleByProject,onEachFeature:(f,layer)=>layer.on('click',()=>layer.bindPopup(zonePopup(f),{maxWidth:360}).openPopup())}).addTo(map);

    const climateLayer = L.geoJSON(DATA_CLIMATE,{
      pointToLayer:(feat,latlng)=>L.circleMarker(latlng,{radius:8,weight:1,color:'#3b82f6',fillColor:'#3b82f6',fillOpacity:.6}),
      onEachFeature:(feat,layer)=>layer.bindTooltip(`${feat.properties.type}: ${feat.properties.value} ${feat.properties.unit}`)
    });

    const hospitalIcon = L.divIcon({className:'', html:'<div style="width:12px;height:12px;border-radius:999px;background:#22c55e;border:2px solid #14532d"></div>', iconSize:[12,12]});
    const healthLayer = L.geoJSON(DATA_HEALTH,{
      pointToLayer:(feat,latlng)=>L.marker(latlng,{icon:hospitalIcon}),
      onEachFeature:(feat,layer)=>{
        const p=feat.properties;
        layer.bindPopup(`<strong>${p.name}</strong><div class="small">${p.address}</div><div class="small">üìû ${p.phone}</div><div class="small">‚úâÔ∏è ${p.email}</div>`);
        layer.bindTooltip(`${p.name} ‚Äî ${p.beds} lits`);
      }
    });

    L.control.layers({ 'OpenStreetMap': basemap }, {
      'Climat (fictif)': climateLayer,
      'Sant√© / H√¥pitaux (fictif)': healthLayer,
      'Zones (score)': zonesLayer
    }, {collapsed:false, position:'topright'}).addTo(map);

    const legend = L.control({position:'bottomright'});
    legend.onAdd = function(){ const d=L.DomUtil.create('div','legend'); d.innerHTML =
      `<div style="font-weight:700;margin-bottom:6px;">L√©gende</div>
       <div><span class="badge b-good">‚â•70%</span> Forte correspondance</div>
       <div><span class="badge b-warn">45‚Äì69%</span> Moyenne</div>
       <div><span class="badge b-poor">&lt;45%</span> Faible</div>`;
      return d;
    };
    legend.addTo(map);

    /* ----- Formulaire Urbanisme ----- */
    const formUrban = document.getElementById('form-urban');
    const urbanResult = document.getElementById('urban-result');

    function refreshZoneStyles(){ zonesLayer.setStyle(styleByProject); }

    formUrban?.addEventListener('submit',(e)=>{
      e.preventDefault();
      const data = new FormData(formUrban);
      const project = data.get('project') || 'hospital';
      const mode = data.get('mode') || 'map';
      currentProject = project;
      refreshZoneStyles();

      if(mode==='map'){
        urbanResult.classList.remove('hidden');
        urbanResult.innerHTML = '<span class="small">Cliquez une zone sur la carte pour afficher le score et les crit√®res.</span>';
        goto('map');
      }else{
        const ranked = DATA_ZONES.features
          .map(f=>({ id:f.properties.id, name:f.properties.name, pct:scoreZone(f.properties,project).pct, feature:f }))
          .sort((a,b)=>b.pct-a.pct).slice(0,3);

        urbanResult.classList.remove('hidden');
        urbanResult.innerHTML = '<div class="card" style="background:transparent;border:none;">'
          +'<div class="hd">Zones recommand√©es</div><div class="bd">'
          + ranked.map(r=>`<div style="display:flex;justify-content:space-between;margin-bottom:6px;">
               <div><strong>${r.name}</strong></div>
               <div><span class="badge ${r.pct>=70?'b-good':r.pct>=45?'b-warn':'b-poor'}">${r.pct}%</span></div>
             </div>`).join('')
          +'</div></div>';

        goto('map');
        const top = ranked[0];
        const temp = L.geoJSON(top.feature).addTo(map);
        map.fitBounds(temp.getBounds(),{padding:[20,20]});
        setTimeout(()=>{ const poly=zonesLayer.getLayers().find(l=>l.feature.properties.id===top.id); if(poly) poly.fire('click'); map.removeLayer(temp); },300);
      }
    });
  </script>
</body>
</html>
